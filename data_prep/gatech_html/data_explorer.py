import json
import os
import sys
from pathlib import Path
from bs4 import BeautifulSoup, Comment, XMLParsedAsHTMLWarning
import re
from urllib.parse import urljoin, urlparse
import warnings

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

project_root = Path(__file__).parent.parent.parent

gatech_meta_path = project_root / "scraper" / "gatech_crawl" / "gatech_meta.jsonl"
posts_gatech_path = project_root / "scraper" / "reddit" / "posts_gatech.jsonl"
html_path = project_root / "scraper" / "gatech_crawl" / "html"

warnings.filterwarnings("ignore", category=XMLParsedAsHTMLWarning)


BAD_HREF = re.compile(
    r"^\s*$|"            # empty
    r"\s|"               # contains spaces
    r"^(#|mailto:|javascript:)",  # fragments & JS links
    re.I
)

BOILERPLATE = [
    "Offices and Departments", "News Center", "Campus Calendar", "Special Events",
    "GreenBuzz", "Institute Communications", "Campus Visits", "Directions to Campus",
    "Visitor Parking Information", "GT visitor Wireless Network Information",
    "Georgia Tech Global Learning Center", "Georgia Tech Hotel and Conference Center",
    "Barnes and Noble at Georgia Tech", "Ferst Center for the Arts",
    "Robert C. Williams Paper Museum", "College of Computing", "College of Design",
    "College of Engineering", "College of Lifetime Learning", "College of Sciences",
    "Ivan Allen College of Liberal Arts", "Scheller College of Business",
    "Georgia Tech-Europe", "Georgia Tech-Shenzhen", "Georgia Tech Online",
    "Professional Education", "The Language Institute", "Global Engagement",
    "Research at Georgia Tech", "Georgia Tech Research Institute", "Commercialization",
    "Enterprise Innovation Institute", "Corporate Engagement", "Apply", "BuzzPort",
    "Buzzcard", "Career Center", "Commencement", "Graduate and Postdoctoral Education",
    "Undergraduate Education", "Library", "Student Life", "Student Entrepreneurship",
    "Education Abroad", "Canvas", "Parent and Family Programs",
    "Division of Student Life", "Scholarships and Financial Aid",
    "Administration and Finance", "Advising and Teaching", "Faculty Affairs",
    "Faculty Hiring", "Postdoctoral Services", "Human Resources", "Staff Council",
    "TechWorks", "Alumni Association", "Alumni Career Services", "Foundation",
    "Giving Back to Tech", "Startup Companies", "Economic Development",
    "Industry Engagement", "Institute Relations", "Professional Education",
    "Georgia Institute of Technology", "North Avenue", "Atlanta, GA 30332",
    "+1 404.894.2000", "Campus Map", "Directory", "Employment",
    "Emergency Information", "Equal Opportunity, Nondiscrimination, and Anti-Harassment Policy",
    "Legal & Privacy Information", "Human Trafficking Notice",
    "Title IX/Sexual Misconduct", "Hazing Public Disclosures", "Accessibility",
    "Accountability", "Accreditation", "Report Free Speech and Censorship Concern",
    "Georgia Tech", "2025 Georgia Institute of Technology"
]
boilerplate = set([word.lower() for word in BOILERPLATE])

def load_reddit_data():
    posts_data = []
    with open(posts_gatech_path, 'r') as f:
        for line in f:
            posts_data.append(json.loads(line.strip()))
    return posts_data

def load_gatech_data():
    gatech_meta_data = []
    with open(gatech_meta_path, 'r') as f:
        for line in f:
            gatech_meta_data.append(json.loads(line.strip()))

    return gatech_meta_data

def find_all_extensions(meta_data):
    counts = {}
    for record in meta_data:
        sha = record.get('sha')
        if '.' in sha[-5:]:
            extension = sha[-5:].split('.')[-1]
            counts[extension] = counts.get(extension, 0) + 1
    return counts

def remove_extensions(meta_data):
    new_meta_data = []
    keep_ext = ['html','htm']
    for record in meta_data:
        sha = record.get('sha')
        if '.' in sha[-5:]:
            extension = sha[-5:].split('.')[-1]
            if extension in keep_ext:
                new_meta_data.append(record)
        else:
            new_meta_data.append(record)
    return new_meta_data
            
def remove_short_pages(meta_data, html_dir, min_words=100, boilerplate=boilerplate):

    def extract_visible_text(html):
        soup = BeautifulSoup(html, "lxml")

        for sel in ["header", "footer", "nav", "aside", ".gt-menu", ".gt-footer", ".site-header", ".site-footer"]:
            for node in soup.select(sel):
                node.decompose()

        for tag in soup(["script", "style", "noscript", "meta", "link"]):
            tag.decompose()

        for c in soup.find_all(string=lambda t: isinstance(t, Comment)):
            c.extract()

        text = soup.get_text(" ", strip=True)
    
        # Remove template debugging strings
        text = re.sub(r'THEME OUTPUT|DEBUG|HOOK:|BEGIN|END|SUGGESTIONS:|FILE NAME', ' ', text)
        # Remove file paths and template references
        text = re.sub(r"'[^']*\.html\.twig'", ' ', text)
        text = re.sub(r"'[^']*templates[^']*'", ' ', text)
        # Remove HTML tags that might have survived
        text = re.sub(r'<[^>]*>', ' ', text)
        # Remove special characters and collapse whitespace
        text = re.sub(r'[^\w\s]', ' ', text)
        text = re.sub(r'\s+', ' ', text).strip()
        
        return text
    
    kept = []
    word_counts = {}
    idxs = []
    for i, record in enumerate(meta_data):
        # print progress every 500
        if i % 500 == 0:
            print(f"Checking length for {i}/{len(meta_data)}")

        sha = record.get("sha")
        if not sha:
            continue

        fp = html_dir / f"{sha}.html"
        if not fp.exists():
            continue

        try:
            html = fp.read_text(encoding="utf-8", errors="replace")
            # extract and clean text
            text = extract_visible_text(html)
            # remove boilerplate phrases
            for phrase in boilerplate:
                text = text.replace(phrase, " ")
            
            # Split into words and filter
            words = [w.lower() for w in text.split() if w and len(w) > 1]
            
            if len(words) >= min_words:
                kept.append(record)
                idxs.append(i)
            # Only count words for documents we're keeping
            if len(words) >= min_words:
                for word in words:
                    if not word.isdigit() and not (word.startswith("'") or word.endswith("'")):
                        word_counts[word] = word_counts.get(word, 0) + 1
                        
        except Exception as e:
            print(f"Error reading {fp}: {e}")

    print(f"Kept {len(kept)}/{len(meta_data)} documents after filtering")
    #print("Top 100 words by frequency:")
    #print(sorted(word_counts.items(), key=lambda x: x[1], reverse=True)[:100])
    return kept, idxs

def remove_all_wp_pages(meta_data):
    new_meta_data = []
    for record in meta_data:
        if 'wp-' not in record.get('sha'):
            new_meta_data.append(record)
    return new_meta_data

def count_links_distribution(meta_data, html_dir):
    link_distribution = {}
    
    for i, record in enumerate(meta_data):
        # Print progress every 500 files
        if i % 500 == 0:
            print(f"Processing file {i}/{len(meta_data)}")
            
        sha = record.get("sha")
        if not sha:
            continue
            
        fp = html_dir / f"{sha}.html"
        if not fp.exists():
            continue
            
        try:
            # Read and parse the HTML
            html = fp.read_text(encoding="utf-8", errors="replace")
            soup = BeautifulSoup(html, "lxml")
            
            # Count all links (a tags)
            links = soup.find_all('a')
            link_count = len(links)
            
            # Update distribution dictionary
            link_distribution[link_count] = link_distribution.get(link_count, 0) + 1
                
        except Exception as e:
            print(f"Error processing {fp}: {e}")
    
    # Sort the dictionary by key for easier reading
    sorted_distribution = dict(sorted(link_distribution.items()))
    
    print(f"Processed {len(meta_data)} files")
    print(f"Found files with between {min(sorted_distribution.keys())} and {max(sorted_distribution.keys())} links")
    
    return sorted_distribution

STOP_HREF_PREFIX = ("#", "mailto:", "javascript")

def extract_visible_text(node):
    """Return visible text in `node`, minus comments / scripts / nav junk."""
    for thrash in node(["script", "style", "noscript"]):
        thrash.decompose()
    for c in node.find_all(string=lambda t: isinstance(t, Comment)):
        c.extract()
    return node.get_text(" ", strip=True)

def clean_anchor_text(text):
    """Collapse whitespace, drop very long anchors (>8 words)."""
    text = re.sub(r"\s+", " ", text).strip()
    if 1 <= len(text.split()) <= 8:
        return text
    return None                     # skip gigantic menu items

def get_context(anchor, window=40):
    """
    Grab `window` tokens before+after the anchor inside its parent element.
    Very lightweight but yields surprisingly good context.
    """
    parent_text = extract_visible_text(anchor.parent)
    # highlight anchor text with sentinel
    marker = "<<<ANCHOR>>>"
    parent_text = parent_text.replace(anchor.get_text(strip=True), f" {marker} ")
    toks = parent_text.split()
    try:
        idx = toks.index(marker)
    except ValueError:
        return None
    lo = max(0, idx - window)
    hi = min(len(toks), idx + window + 1)
    # remove marker, collapse
    context = " ".join([t for t in toks[lo:hi] if t != marker])
    return context

def is_valid_href(href: str) -> bool:
    """Reject placeholders, JS, mailto, whitespace, etc."""
    if BAD_HREF.search(href):
        return False
    # reject obvious placeholders like "link_to_be_added" or "tbd"
    if "to be added" in href.lower() or "tbd" in href.lower():
        return False
    return True

def make_triplets(meta_data, html_dir: Path, out_path: Path):
    out = out_path.open("w")
    total_links = kept_links = 0

    for i, rec in enumerate(meta_data):
        if i % 500 == 0:
            print(f"Parsing anchors {i}/{len(meta_data)} …")

        sha, url_base = rec.get("sha"), rec.get("url")
        if not sha or not url_base:
            continue
        fp = html_dir / f"{sha}.html"
        if not fp.exists():
            continue

        soup = BeautifulSoup(fp.read_text(errors="replace"), "lxml")

        for a in soup.find_all("a", href=True):
            total_links += 1
            href = a["href"].strip()
            if not is_valid_href(href):
                continue

            try:
                target_url = urljoin(url_base, href)
            except ValueError:
                continue                       # malformed – skip

            anchor_txt = clean_anchor_text(a.get_text(" ", strip=True))
            if not anchor_txt:
                continue

            context = get_context(a)
            if not context:
                continue

            kept_links += 1
            out.write(json.dumps({
                'sha':sha,
                "anchor":  anchor_txt,
                "context": context,
                "url":     target_url
            }) + "\n")

    out.close()
    print(f"✔ wrote {kept_links:,} triples (out of {total_links:,} <a> tags) → {out_path}")

# Usage example
meta_data = load_gatech_data()
posts_data = load_reddit_data()
#print(find_average_length(meta_data, posts_data))
#print(find_average_links(meta_data, posts_data))
#print(len(remove_extensions(meta_data)))
#print(len(remove_all_wp_pages(meta_data)))
'''
- no pdfs (1128) - DONE
- no images or media - DONE
- no <100 words pages (after cleanup)
- no login, signup, logout
'''
#print(find_docs_with_low_length(meta_data, posts_data))
#meta_data = remove_extensions(meta_data)
#meta_data = remove_all_wp_pages(meta_data)
#meta_data, idxs = remove_short_pages(meta_data, html_path, min_words=150)

#print(idxs)

#with open("idx.txt", "w") as f:
#    for idx in idxs:
#        f.write(f"{idx}\n")

idxs = [
    0, 1, 2, 3, 4, 5, 6, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 26, 27, 31, 32, 33, 34, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 48, 49, 51, 53, 57, 58, 59, 60, 61, 62, 63, 64, 65, 67, 70, 72, 73, 78, 84, 98, 101, 103, 106, 112, 113, 114, 115, 118, 119, 120, 121, 122, 123, 124, 126, 127, 129, 130, 131, 136, 137, 138, 139, 140, 141, 144, 147, 149, 158, 160, 161, 162, 163, 167, 172, 174, 182, 190, 191, 192, 193, 194, 195, 197, 199, 200, 201, 202, 203, 205, 206, 207, 215, 249, 251, 252, 254, 256, 258, 264, 265, 266, 267, 268, 271, 273, 275, 277, 278, 281, 283, 286, 287, 289, 291, 292, 293, 294, 295, 296, 297, 298, 299, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 313, 315, 316, 317, 318, 319, 320, 321, 323, 325, 326, 329, 332, 333, 335, 337, 340, 342, 343, 344, 345, 346, 348, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 361, 364, 365, 371, 372, 373, 375, 376, 378, 379, 380, 381, 382, 383, 384, 386, 387, 390, 391, 393, 394, 398, 399, 400, 403, 404, 405, 406, 407, 408, 409, 410, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 427, 428, 429, 430, 431, 432, 433, 436, 440, 441, 450, 451, 483, 484, 485, 486, 487, 499, 500, 501, 505, 506, 507, 509, 510, 511, 513, 514, 516, 517, 519, 520, 523, 527, 528, 530, 531, 534, 536, 537, 539, 546, 551, 558, 560, 562, 563, 564, 566, 568, 569, 573, 574, 575, 577, 578, 579, 581, 583, 584, 591, 592, 593, 594, 596, 597, 598, 599, 605, 606, 607, 608, 609, 613, 614, 618, 621, 622, 623, 624, 625, 627, 629, 635, 636, 638, 639, 642, 649, 655, 657, 674, 678, 679, 681, 687, 688, 689, 690, 691, 692, 694, 695, 697, 700, 701, 703, 707, 708, 711, 712, 713, 715, 716, 717, 719, 721, 723, 724, 725, 726, 727, 728, 729, 730, 731, 732, 736, 737, 739, 740, 741, 742, 743, 744, 745, 747, 752, 754, 755, 756, 758, 759, 761, 765, 766, 767, 768, 769, 770, 771, 772, 773, 774, 776, 777, 779, 780, 781, 783, 784, 785, 786, 788, 789, 792, 794, 796, 797, 798, 800, 801, 802, 804, 805, 806, 808, 810, 811, 812, 814, 816, 818, 823, 826, 828, 834, 836, 846, 847, 849, 850, 852, 853, 856, 857, 858, 859, 861, 862, 863, 864, 865, 866, 867, 868, 869, 872, 874, 879, 881, 882, 883, 884, 887, 890, 892, 894, 898, 899, 900, 901, 903, 904, 906, 907, 908, 909, 911, 913, 914, 915, 916, 917, 918, 919, 920, 923, 924, 926, 927, 928, 930, 931, 935, 936, 939, 941, 943, 945, 946, 947, 949, 950, 951, 952, 953, 954, 955, 956, 961, 962, 965, 966, 967, 968, 971, 978, 985, 986, 987, 989, 990, 992, 996, 997, 1001, 1002, 1006, 1007, 1010, 1012, 1013, 1015, 1016, 1017, 1018, 1019, 1020, 1021, 1022, 1023, 1024, 1025, 1026, 1027, 1028, 1029, 1030, 1031, 1032, 1033, 1034, 1035, 1037, 1039, 1040, 1043, 1044, 1045, 1048, 1049, 1051, 1053, 1054, 1055, 1056, 1058, 1059, 1060, 1061, 1063, 1065, 1066, 1068, 1070, 1075, 1077, 1078, 1079, 1081, 1082, 1083, 1085, 1086, 1088, 1089, 1090, 1091, 1092, 1093, 1094, 1095, 1096, 1097, 1098, 1099, 1100, 1101, 1102, 1103, 1104, 1105, 1106, 1107, 1108, 1109, 1110, 1111, 1112, 1113, 1114, 1115, 1116, 1117, 1119, 1120, 1121, 1122, 1123, 1124, 1125, 1126, 1127, 1128, 1129, 1131, 1134, 1135, 1136, 1137, 1139, 1140, 1141, 1142, 1143, 1145, 1146, 1147, 1149, 1150, 1151, 1152, 1154, 1156, 1157, 1158, 1159, 1160, 1161, 1162, 1164, 1165, 1167, 1169, 1170, 1172, 1173, 1175, 1178, 1179, 1180, 1181, 1183, 1184, 1185, 1186, 1187, 1188, 1189, 1190, 1191, 1193, 1194, 1195, 1196, 1197, 1199, 1200, 1202, 1204, 1206, 1207, 1209, 1210, 1211, 1212, 1213, 1214, 1215, 1216, 1217, 1218, 1219, 1222, 1223, 1224, 1227, 1228, 1229, 1234, 1237, 1238, 1239, 1240, 1243, 1245, 1247, 1249, 1250, 1252, 1254, 1258, 1260, 1262, 1264, 1266, 1267, 1269, 1271, 1273, 1275, 1276, 1277, 1278, 1279, 1280, 1281, 1282, 1283, 1284, 1285, 1286, 1287, 1288, 1289, 1291, 1292, 1293, 1295, 1296, 1298, 1299, 1300, 1301, 1302, 1304, 1305, 1306, 1307, 1308, 1309, 1310, 1311, 1312, 1314, 1315, 1316, 1317, 1318, 1319, 1320, 1321, 1322, 1323, 1324, 1328, 1330, 1332, 1333, 1334, 1335, 1336, 1337, 1338, 1339, 1341, 1342, 1344, 1345, 1346, 1349, 1351, 1352, 1353, 1356, 1357, 1362, 1363, 1365, 1367, 1369, 1371, 1373, 1382, 1389, 1394, 1397, 1411, 1425, 1432, 1436, 1440, 1445, 1449, 1459, 1460, 1462, 1467, 1470, 1473, 1474, 1477, 1478, 1482, 1483, 1486, 1488, 1490, 1493, 1494, 1496, 1500, 1518, 1555, 1556, 1560, 1562, 1563, 1571, 1573, 1577, 1578, 1580, 1581, 1582, 1583, 1584, 1585, 1588, 1589, 1590, 1591, 1593, 1595, 1596, 1597, 1598, 1599, 1600, 1601, 1602, 1603, 1604, 1605, 1606, 1607, 1608, 1609, 1610, 1611, 1612, 1613, 1614, 1616, 1618, 1619, 1620, 1621, 1622, 1623, 1624, 1625, 1626, 1627, 1628, 1629, 1630, 1631, 1633, 1634, 1635, 1636, 1637, 1638, 1639, 1640, 1641, 1642, 1643, 1644, 1645, 1646, 1647, 1648, 1653, 1655, 1656, 1657, 1658, 1660, 1662, 1663, 1664, 1666, 1667, 1668, 1670, 1672, 1673, 1674, 1675, 1676, 1677, 1678, 1679, 1681, 1682, 1683, 1684, 1685, 1687, 1688, 1690, 1691, 1694, 1695, 1698, 1700, 1701, 1703, 1704, 1707, 1709, 1710, 1712, 1714, 1716, 1717, 1720, 1722, 1725, 1729, 1730, 1731, 1733, 1734, 1735, 1736, 1740, 1741, 1743, 1744, 1746, 1747, 1748, 1750, 1752, 1753, 1754, 1755, 1756, 1757, 1759, 1761, 1763, 1764, 1766, 1767, 1768, 1769, 1770, 1771, 1773, 1775, 1776, 1777, 1778, 1779, 1780, 1781, 1782, 1783, 1784, 1786, 1788, 1790, 1792, 1793, 1795, 1796, 1797, 1798, 1800, 1801, 1802, 1803, 1804, 1805, 1806, 1807, 1808, 1809, 1812, 1813, 1814, 1816, 1817, 1818, 1819, 1821, 1822, 1823, 1826, 1827, 1828, 1829, 1831, 1832, 1833, 1834, 1835, 1836, 1837, 1838, 1839, 1842, 1844, 1845, 1846, 1847, 1848, 1849, 1850, 1851, 1853, 1854, 1855, 1856, 1857, 1858, 1859, 1860, 1861, 1862, 1863, 1864, 1865, 1867, 1868, 1869, 1870, 1871, 1872, 1873, 1874, 1875, 1876, 1878, 1879, 1880, 1881, 1882, 1883, 1884, 1885, 1886, 1887, 1888, 1889, 1890, 1891, 1892, 1893, 1895, 1896, 1897, 1899, 1900, 1901, 1902, 1903, 1905, 1906, 1907, 1908, 1909, 1910, 1911, 1912, 1913, 1914, 1915, 1916, 1917, 1918, 1919, 1920, 1921, 1922, 1923, 1924, 1925, 1926, 1927, 1928, 1929, 1930, 1932, 1933, 1934, 1935, 1937, 1938, 1939, 1940, 1941, 1942, 1943, 1945, 1946, 1947, 1948, 1949, 1950, 1951, 1953, 1954, 1955, 1956, 1957, 1958, 1959, 1960, 1961, 1962, 1963, 1964, 1965, 1966, 1967, 1968, 1969, 1970, 1971, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980, 1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 1990, 1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025, 2027, 2028, 2029, 2030, 2031, 2032, 2033, 2034, 2035, 2036, 2038, 2039, 2040, 2043, 2044, 2048, 2050, 2051, 2052, 2053, 2054, 2057, 2059, 2060, 2064, 2065, 2067, 2069, 2070, 2071, 2072, 2073, 2074, 2075, 2076, 2077, 2078, 2079, 2080, 2081, 2082, 2083, 2084, 2085, 2086, 2087, 2088, 2090, 2091, 2092, 2093, 2094, 2095, 2096, 2097, 2098, 2099, 2100, 2101, 2102, 2103, 2104, 2105, 2106, 2107, 2108, 2109, 2110, 2112, 2114, 2115, 2116, 2117, 2118, 2119, 2120, 2121, 2122, 2123, 2124, 2125, 2127, 2128, 2132, 2134, 2137, 2138, 2139, 2144, 2145, 2146, 2147, 2148, 2150, 2151, 2153, 2154, 2155, 2157, 2158, 2162, 2163, 2165, 2166, 2167, 2168, 2172, 2174, 2177, 2178, 2179, 2180, 2181, 2184, 2185, 2187, 2194, 2195, 2197, 2199, 2205, 2209, 2211, 2214, 2215, 2217, 2218, 2219, 2221, 2224, 2226, 2227, 2228, 2231, 2232, 2235, 2236, 2237, 2239, 2240, 2241, 2242, 2245, 2246, 2247, 2248, 2249, 2250, 2251, 2253, 2254, 2255, 2256, 2257, 2258, 2259, 2260, 2261, 2262, 2263, 2266, 2267, 2268, 2270, 2271, 2272, 2273, 2274, 2275, 2276, 2280, 2281, 2286, 2287, 2289, 2290, 2291, 2292, 2293, 2294, 2295, 2297, 2299, 2300, 2301, 2302, 2303, 2304, 2305, 2306, 2307, 2308, 2309, 2310, 2311, 2312, 2313, 2316, 2317, 2319, 2320, 2321, 2322, 2324, 2325, 2328, 2329, 2332, 2333, 2334, 2335, 2336, 2337, 2340, 2341, 2342, 2344, 2345, 2346, 2347, 2348, 2349, 2350, 2351, 2352, 2353, 2355, 2356, 2358, 2359, 2360, 2362, 2363, 2364, 2365, 2367, 2368, 2371, 2374, 2381, 2382, 2384, 2385, 2388, 2389, 2393, 2394, 2396, 2398, 2402, 2404, 2405, 2406, 2407, 2408, 2409, 2410, 2411, 2413, 2414, 2415, 2416, 2418, 2419, 2421, 2422, 2424, 2425, 2426, 2427, 2428, 2429, 2430, 2432, 2434, 2436, 2450, 2451, 2453, 2458, 2462, 2466, 2467, 2469, 2470, 2474, 2475, 2477, 2479, 2480, 2481, 2483, 2485, 2487, 2489, 2491, 2494, 2496, 2497, 2498, 2499, 2500, 2501, 2503, 2504, 2505, 2506, 2507, 2510, 2511, 2512, 2513, 2515, 2516, 2517, 2520, 2522, 2523, 2525, 2527, 2529, 2536, 2540, 2544, 2545, 2547, 2548, 2550, 2551, 2553, 2556, 2557, 2558, 2559, 2560, 2561, 2562, 2564, 2565, 2566, 2567, 2568, 2569, 2570, 2571, 2572, 2573, 2574, 2575, 2576, 2577, 2578, 2579, 2580, 2581, 2582, 2583, 2584, 2585, 2586, 2587, 2588, 2589, 2590, 2591, 2592, 2593, 2594, 2595, 2596, 2597, 2598, 2599, 2600, 2601, 2602, 2603, 2604, 2605, 2606, 2607, 2609, 2610, 2611, 2612, 2613, 2614, 2616, 2617, 2619, 2621, 2622, 2623, 2624, 2625, 2626, 2627, 2628, 2629, 2630, 2632, 2633, 2634, 2635, 2636, 2637, 2639, 2641, 2643, 2644, 2645, 2647, 2648, 2650, 2651, 2652, 2653, 2654, 2655, 2656, 2657, 2658, 2660, 2661, 2662, 2663, 2665, 2666, 2667, 2669, 2671, 2672, 2673, 2674, 2675, 2676, 2677, 2678, 2679, 2680, 2681, 2682, 2683, 2684, 2686, 2687, 2688, 2689, 2690, 2691, 2692, 2693, 2694, 2695, 2696, 2697, 2698, 2700, 2701, 2702, 2704, 2706, 2707, 2710, 2712, 2717, 2724, 2725, 2728, 2729, 2730, 2731, 2732, 2733, 2734, 2735, 2736, 2737, 2738, 2739, 2741, 2742, 2746, 2748, 2751, 2752, 2753, 2754, 2755, 2756, 2758, 2759, 2760, 2761, 2762, 2763, 2764, 2766, 2767, 2768, 2769, 2770, 2771, 2772, 2774, 2778, 2779, 2780, 2781, 2782, 2783, 2784, 2785, 2786, 2787, 2788, 2789, 2790, 2791, 2792, 2793, 2794, 2795, 2796, 2797, 2798, 2799, 2800, 2801, 2802, 2803, 2804, 2805, 2806, 2807, 2808, 2809, 2810, 2811, 2812, 2813, 2814, 2815, 2816, 2817, 2818, 2819, 2820, 2821, 2822, 2823, 2824, 2825, 2826, 2827, 2829, 2832, 2834, 2835, 2836, 2841, 2842, 2843, 2844, 2845, 2846, 2847, 2849, 2850, 2851, 2852, 2853, 2854, 2855, 2856, 2857, 2858, 2860, 2861, 2862, 2863, 2864, 2866, 2867, 2869, 2870, 2871, 2872, 2873, 2874, 2875, 2878, 2880, 2881, 2882, 2883, 2884, 2885, 2886, 2887, 2888, 2891, 2892, 2893, 2894, 2895, 2896, 2897, 2898, 2899, 2900, 2901, 2902, 2904, 2905, 2907, 2908, 2910, 2911, 2912, 2913, 2914, 2916, 2918, 2919, 2920, 2921, 2922, 2923, 2924, 2926, 2929, 2930, 2932, 2933, 2942, 2944, 2945, 2947, 2949, 2950, 2951, 2954, 2957, 2964, 2965, 2969, 2971, 2974, 2976, 2977, 2978, 2980, 2981, 2983, 2985, 2986, 2987, 2988, 2989, 2990, 2991, 2993, 2994, 2995, 2996, 2997, 2998, 2999, 3000, 3002, 3003, 3004, 3010, 3011, 3012, 3013, 3014, 3015, 3019, 3020, 3021, 3022, 3023, 3024, 3025, 3037, 3041, 3043, 3044, 3054, 3055, 3058, 3059, 3061, 3062, 3063, 3066, 3067, 3071, 3074, 3075, 3076, 3082, 3084, 3085, 3093, 3096, 3097, 3099, 3101, 3102, 3112, 3118, 3119, 3124, 3128, 3133, 3143, 3153, 3159, 3163, 3179, 3186, 3188, 3189, 3234, 3245, 3246, 3262, 3269, 3272, 3285, 3298, 3299, 3300, 3311, 3312, 3316, 3317, 3318, 3319, 3329, 3330, 3333, 3338, 3340, 3341, 3343, 3347, 3349, 3354, 3375, 3384, 3386, 3398, 3399, 3401, 3404, 3405, 3407, 3408, 3410, 3412, 3415, 3426, 3431, 3433, 3445, 3452, 3453, 3455, 3456, 3457, 3458, 3460, 3461, 3462, 3463, 3471, 3472, 3473, 3476, 3478, 3483, 3484, 3488, 3489, 3491, 3492, 3493, 3495, 3496, 3497, 3498, 3499, 3500, 3508, 3509, 3510, 3511, 3516, 3517, 3518, 3519, 3520, 3521, 3522, 3523, 3524, 3525, 3526, 3528, 3529, 3530, 3531, 3532, 3533, 3534, 3535, 3540, 3543, 3544, 3545, 3546, 3547, 3548, 3549, 3550, 3551, 3552, 3553, 3554, 3555, 3556, 3557, 3558, 3559, 3560, 3561, 3567, 3570, 3572, 3573, 3574, 3575, 3576, 3577, 3578, 3579, 3580, 3581, 3582, 3583, 3584, 3585, 3586, 3587, 3588, 3589, 3590, 3591, 3592, 3595, 3600, 3602, 3603, 3604, 3605, 3606, 3607, 3608, 3609, 3610, 3611, 3612, 3613, 3614, 3615, 3616, 3617, 3618, 3619, 3620, 3621, 3622, 3623, 3624, 3625, 3626, 3627, 3628, 3629, 3630, 3631, 3632, 3633, 3634, 3635, 3636, 3637, 3638, 3642, 3644, 3649, 3657, 3658, 3661, 3665, 3669, 3671, 3672, 3676, 3679, 3682, 3685, 3687, 3688, 3690, 3691, 3693, 3701, 3704, 3708, 3712, 3714, 3715, 3717, 3723, 3726, 3729, 3731, 3734, 3744, 3747, 3750, 3752, 3753, 3754, 3755, 3756, 3757, 3758, 3759, 3760, 3769, 3771, 3773, 3775, 3778, 3781, 3782, 3786, 3788, 3789, 3790, 3791, 3792, 3793, 3795, 3797, 3798, 3799, 3802, 3803, 3805, 3806, 3807, 3809, 3810, 3811, 3812, 3814, 3815, 3817, 3818, 3820, 3821, 3822, 3823, 3826, 3827, 3828, 3832, 3834, 3835, 3836, 3837, 3839, 3840, 3842, 3844, 3845, 3846, 3848, 3852, 3853, 3854, 3856, 3858, 3859, 3864, 3865, 3866, 3867, 3868, 3872, 3873, 3874, 3875, 3876, 3877, 3878, 3879, 3880, 3881, 3882, 3883, 3884, 3885, 3886, 3887, 3888, 3889, 3890, 3891, 3892, 3893, 3894, 3895, 3897, 3898, 3900, 3901, 3903, 3904, 3905, 3906, 3907, 3908, 3911, 3913, 3916, 3920, 3921, 3923, 3927, 3930, 3934, 3937, 3941, 3951, 3952, 3960, 3961, 3972, 3973, 3974, 3975, 3976, 3977, 3990, 4005, 4018, 4026, 4029, 4042, 4043, 4047, 4103, 4122, 4124, 4127, 4129, 4130, 4131, 4132, 4133, 4134, 4135, 4136, 4137, 4138, 4140, 4141, 4142, 4144, 4146, 4147, 4148, 4149, 4151, 4152, 4155, 4156, 4158, 4159, 4160, 4161, 4162, 4163, 4164, 4165, 4166, 4167, 4168, 4169, 4170, 4173, 4174, 4176, 4177, 4179, 4180, 4181, 4182, 4183, 4184, 4185, 4186, 4187, 4188, 4189, 4190, 4191, 4192, 4193, 4194, 4196, 4197, 4199, 4201, 4202, 4203, 4204, 4205, 4207, 4211, 4213, 4214, 4216, 4217, 4218, 4221, 4222, 4223, 4224, 4225, 4226, 4227, 4229, 4234, 4236, 4237, 4239, 4241, 4242, 4243, 4244, 4245, 4249, 4251, 4252, 4253, 4254, 4255, 4258, 4260, 4261, 4262, 4263, 4264, 4266, 4267, 4268, 4269, 4271, 4272, 4273, 4274, 4275, 4276, 4277, 4278, 4283, 4285, 4288, 4290, 4291, 4292, 4293, 4294, 4295, 4296, 4297, 4298, 4299, 4300, 4301, 4302, 4303, 4304, 4305, 4306, 4307, 4308, 4309, 4310, 4311, 4312, 4313, 4314, 4315, 4316, 4318, 4319, 4320, 4321, 4322, 4324, 4326, 4328, 4331, 4332, 4334, 4336, 4338, 4339, 4340, 4341, 4342, 4343, 4344, 4345, 4346, 4348, 4350, 4352, 4353, 4355, 4356, 4357, 4358, 4359, 4361, 4363, 4364, 4367, 4368, 4369, 4370, 4371, 4372, 4374, 4376, 4378, 4381, 4382, 4383, 4384, 4385, 4386, 4387, 4389, 4391, 4393, 4394, 4395, 4397, 4398, 4399, 4400, 4402, 4403, 4404, 4405, 4408, 4409, 4410, 4411, 4414, 4415, 4417, 4418, 4419, 4420, 4421, 4422, 4433, 4436, 4437, 4438, 4440, 4441, 4442, 4443, 4444, 4445, 4447, 4449, 4450, 4453, 4454, 4455, 4456, 4459, 4464, 4465, 4466, 4467, 4468, 4469, 4471, 4472, 4473, 4474, 4475, 4476, 4477, 4478, 4479, 4483, 4484, 4485, 4486, 4487, 4489, 4494, 4496, 4498, 4499, 4501, 4503, 4504, 4505, 4507, 4508, 4510, 4511, 4513, 4514, 4516, 4517, 4519, 4522, 4525, 4528, 4530, 4532, 4533, 4537, 4542, 4543, 4550, 4551, 4556, 4557, 4558, 4559, 4560, 4561, 4562, 4563, 4564, 4565, 4566, 4567, 4568, 4570, 4571, 4572, 4575, 4576, 4578, 4579, 4580, 4583, 4584, 4586, 4588, 4589, 4591, 4595, 4596, 4599, 4600, 4602, 4605, 4607, 4609, 4612, 4613, 4615, 4616, 4617, 4618, 4619, 4620, 4621, 4622, 4623, 4624, 4625, 4626, 4627, 4628, 4629, 4630, 4631, 4632, 4633, 4634, 4637, 4640, 4646, 4647, 4648, 4649, 4651, 4653, 4655, 4656, 4658, 4659, 4661, 4664, 4666, 4668, 4674, 4675, 4679, 4681, 4682, 4683, 4684, 4685, 4686, 4687, 4689, 4693, 4694, 4698, 4700, 4702, 4706, 4710, 4713, 4714, 4716, 4718, 4722, 4723, 4725, 4726, 4731, 4733, 4735, 4737, 4740, 4741, 4743, 4745, 4746, 4747, 4748, 4749, 4750, 4751, 4752, 4753, 4754, 4755, 4756, 4757, 4758, 4760, 4762, 4765, 4769, 4771, 4775, 4779, 4781, 4782, 4786, 4790, 4795, 4800, 4802, 4803, 4804, 4808, 4813, 4816, 4818, 4819, 4820, 4821, 4822, 4823, 4824, 4825, 4826, 4827, 4828, 4829, 4830, 4832, 4833, 4835, 4840, 4843, 4844, 4845, 4846, 4847, 4849, 4850, 4851, 4852, 4853, 4854, 4855, 4856, 4857, 4860, 4862, 4863, 4864, 4865, 4866, 4867, 4868, 4869, 4870, 4871, 4872, 4873, 4874, 4877, 4879, 4880, 4881, 4882, 4883, 4885, 4886, 4887, 4888, 4889, 4890, 4891, 4892, 4893, 4894, 4895, 4896, 4897, 4898, 4899, 4900, 4901, 4902, 4903, 4904, 4905, 4906, 4907, 4908, 4909, 4920, 4921, 4922, 4923, 4924, 4925, 4931, 4932, 4933, 4934, 4935, 4938, 4940, 4942, 4949, 4951, 4958, 4959, 4963, 4964, 4965, 4966, 4972, 4976, 4982, 4986, 4987, 4991, 4992, 4997, 4998, 5005, 5006, 5014, 5022, 5028, 5036, 5040, 5041, 5042, 5044, 5048, 5052, 5056, 5057, 5061, 5062, 5068, 5069, 5075, 5076, 5085, 5089, 5092, 5096, 5100, 5104, 5105, 5109, 5110, 5114, 5115, 5119, 5120, 5124, 5125, 5126, 5127, 5133, 5134, 5141, 5144, 5146, 5147, 5150, 5154, 5158, 5161, 5165, 5169, 5170, 5174, 5177, 5178, 5183, 5187, 5188, 5192, 5193, 5197, 5198, 5200, 5204, 5208, 5209, 5210, 5211, 5218, 5219, 5220, 5221, 5222, 5223, 5227, 5231, 5235, 5239, 5243, 5244, 5245, 5249, 5250, 5251, 5252, 5256, 5257, 5258, 5259, 5261, 5265, 5268, 5272, 5276, 5280, 5281, 5285, 5286, 5290, 5291, 5295, 5300, 5301, 5307, 5308, 5315, 5317, 5321, 5324, 5328, 5332, 5336, 5337, 5341, 5342, 5346, 5347, 5351, 5352, 5353, 5354, 5355, 5357, 5359, 5360, 5363, 5364, 5365, 5366, 5367, 5370, 5372, 5373, 5376, 5377, 5379, 5380, 5381, 5382, 5385, 5386, 5387, 5388, 5391, 5392, 5393, 5394, 5395, 5398, 5399, 5400, 5401, 5402, 5405, 5406, 5407, 5408, 5409, 5410, 5411, 5414, 5415, 5416, 5417, 5418, 5421, 5422, 5423, 5424, 5425, 5428, 5429, 5432, 5433, 5434, 5437, 5438, 5439, 5446, 5447, 5448, 5450, 5454, 5455, 5463, 5476, 5484, 5488, 5489, 5490, 5499, 5504, 5505, 5513, 5519, 5521, 5525, 5528, 5532, 5533, 5536, 5541, 5542, 5546, 5550, 5551, 5558, 5562, 5564, 5565, 5566, 5574, 5578, 5579, 5581, 5585, 5589, 5593, 5594, 5598, 5601, 5603, 5605, 5606, 5613, 5614, 5620, 5622, 5626, 5630, 5636, 5643, 5644, 5645, 5652, 5656, 5660, 5665, 5668, 5672, 5673, 5677, 5678, 5682, 5686, 5690, 5691, 5698, 5699, 5700, 5707, 5711, 5715, 5719, 5720, 5722, 5726, 5730, 5731, 5735, 5736, 5740, 5743, 5747, 5755, 5756, 5759, 5763, 5772, 5774, 5778, 5779, 5780, 5781, 5782, 5788, 5789, 5790, 5791, 5792, 5793, 5797, 5801, 5802, 5808, 5811, 5815, 5816, 5817, 5818, 5819, 5823, 5824, 5825, 5826, 5827, 5831, 5835, 5839, 5843, 5847, 5848, 5849, 5852, 5853, 5854, 5855, 5857, 5861, 5862, 5863, 5865, 5869, 5873, 5877, 5878, 5881, 5885, 5886, 5887, 5888, 5889, 5893, 5894, 5895, 5896, 5900, 5901, 5905, 5909, 5911, 5915, 5916, 5917, 5918, 5919, 5923, 5924, 5925, 5927, 5931, 5934, 5938, 5939, 5940, 5941, 5945, 5949, 5950, 5951, 5955, 5956, 5957, 5958, 5959, 5963, 5964, 5965, 5968, 5972, 5974, 5978, 5979, 5982, 5986, 5987, 5991, 5995, 5996, 6000, 6001, 6002, 6003, 6004, 6005, 6009, 6010, 6011, 6012, 6013, 6014, 6015, 6016, 6020, 6024, 6025, 6026, 6027, 6028, 6029, 6032, 6033, 6034, 6038, 6042, 6043, 6047, 6048, 6052, 6053, 6057, 6058, 6062, 6065, 6069, 6072, 6073, 6077, 6078, 6079, 6083, 6084, 6085, 6086, 6087, 6091, 6092, 6093, 6094, 6095, 6096, 6097, 6098, 6099, 6103, 6107, 6111, 6114, 6117, 6121, 6122, 6123, 6125, 6129, 6130, 6131, 6135, 6136, 6137, 6141, 6145, 6146, 6147, 6151, 6155, 6159, 6160, 6161, 6163, 6167, 6169, 6173, 6177, 6181, 6183, 6184, 6185, 6186, 6190, 6191, 6192, 6193, 6194, 6195, 6196, 6202, 6206, 6210, 6212, 6216, 6220, 6221, 6225, 6226, 6230, 6231, 6235, 6236, 6237, 6238, 6239, 6240, 6241, 6244, 6245, 6246, 6247, 6248, 6249, 6250, 6251, 6252, 6256, 6260, 6261, 6262, 6263, 6264, 6265, 6267, 6270, 6274, 6275, 6276, 6277, 6278, 6282, 6283, 6284, 6285, 6286, 6290, 6294, 6298, 6302, 6306, 6308, 6312, 6313, 6314, 6316, 6320, 6321, 6322, 6324, 6328, 6332, 6336, 6337, 6338, 6342, 6343, 6344, 6345, 6349, 6350, 6351, 6352, 6354, 6358, 6361, 6365, 6369, 6373, 6374, 6378, 6379, 6383, 6384, 6388, 6389, 6393, 6394, 6395]

meta_data = [meta_data[i] for i in idxs]

make_triplets(meta_data, html_path, Path("triples_gatech.jsonl"))